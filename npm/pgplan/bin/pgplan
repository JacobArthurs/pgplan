#!/usr/bin/env node

"use strict";

const { execFileSync } = require("child_process");
const path = require("path");
const os = require("os");

const PLATFORMS = {
  "linux-x64": { pkg: "@pgplan/linux-x64", bin: "pgplan" },
  "linux-arm64": { pkg: "@pgplan/linux-arm64", bin: "pgplan" },
  "darwin-x64": { pkg: "@pgplan/darwin-x64", bin: "pgplan" },
  "darwin-arm64": { pkg: "@pgplan/darwin-arm64", bin: "pgplan" },
  "win32-x64": { pkg: "@pgplan/win32-x64", bin: "pgplan.exe" },
};

function getPlatformKey() {
  const platform = os.platform();
  const arch = os.arch();
  return `${platform}-${arch}`;
}

function getBinaryPath() {
  const key = getPlatformKey();
  const entry = PLATFORMS[key];
  if (!entry) {
    const supported = Object.keys(PLATFORMS).join(", ");
    console.error(
      `pgplan: unsupported platform ${key}\nSupported: ${supported}`
    );
    process.exit(1);
  }

  try {
    const pkgPath = require.resolve(`${entry.pkg}/package.json`);
    return path.join(path.dirname(pkgPath), entry.bin);
  } catch {
    console.error(
      `pgplan: platform package ${entry.pkg} not installed.\n` +
        `Try reinstalling: npm install pgplan`
    );
    process.exit(1);
  }
}

const binary = getBinaryPath();

try {
  const result = execFileSync(binary, process.argv.slice(2), {
    stdio: "inherit",
    env: process.env,
  });
} catch (e) {
  if (e.status !== null) {
    process.exit(e.status);
  }
  throw e;
}
